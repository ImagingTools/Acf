name: Post Build Analysis

# Automatically post build error analysis when TeamCity CI fails
on:
  workflow_run:
    workflows: ["TeamCity CI"]
    types: [completed]

permissions:
  pull-requests: write
  issues: write
  actions: read

jobs:
  post-analysis:
    name: Post Build Error Analysis
    runs-on: ubuntu-latest
    if: >
      github.event.workflow_run.conclusion == 'failure' &&
      github.event.workflow_run.event == 'pull_request'
    steps:
      - name: Get PR Number
        id: get_pr
        uses: actions/github-script@v8
        with:
          script: |
            const prNumber = github.event.workflow_run.pull_requests[0]?.number;
            if (!prNumber) {
              console.log('No PR found for this workflow run');
              return null;
            }
            console.log(`Found PR #${prNumber}`);
            return prNumber;

      - name: Download TeamCity Build Info Artifacts
        if: steps.get_pr.outputs.result != 'null'
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          pattern: teamcity-build-info-*
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}
          merge-multiple: true
          path: ./teamcity-artifacts

      - name: Extract Build IDs from Artifacts
        if: steps.get_pr.outputs.result != 'null'
        id: extract_build_ids
        shell: bash
        run: |
          BUILD_IDS=""

          # Check if artifacts were downloaded
          if [ -d "./teamcity-artifacts" ]; then
            echo "Artifacts directory found, extracting build IDs..."

            # List all files for debugging
            echo "Files in artifacts directory:"
            ls -la ./teamcity-artifacts/ || true

            # Find all build ID files
            # Expand to nothing if pattern has no matches (instead of literal pattern)
            shopt -s nullglob
            for id_file in ./teamcity-artifacts/teamcity-build-id-*.txt; do
              if [ -f "$id_file" ]; then
                BUILD_ID=$(tr -d '[:space:]' < "$id_file")
                if [ -n "$BUILD_ID" ]; then
                  echo "Found build ID: $BUILD_ID (from $(basename "$id_file"))"
                  BUILD_IDS="$BUILD_IDS $BUILD_ID"
                fi
              fi
            done
            shopt -u nullglob  # Restore default behavior

            # Trim leading/trailing spaces using xargs
            BUILD_IDS=$(echo "$BUILD_IDS" | xargs)

            if [ -z "$BUILD_IDS" ]; then
              echo "No build ID files found in artifacts directory"
              echo "Expected files: teamcity-build-id-windows.txt, teamcity-build-id-linux.txt"
            fi
          else
            echo "No artifacts directory found"
          fi

          # Save to output
          echo "build_ids=$BUILD_IDS" >> "$GITHUB_OUTPUT"
          echo "Build IDs to analyze: $BUILD_IDS"

      - name: Fetch and Analyze Build Errors
        if: steps.get_pr.outputs.result != 'null'
        id: analyze
        env:
          TEAMCITY_URL: ${{ vars.TEAMCITY_URL }}
          TEAMCITY_TOKEN: ${{ vars.TEAMCITY_TOKEN }}
        shell: bash
        run: |
          BUILD_IDS='${{ steps.extract_build_ids.outputs.build_ids }}'

          echo "Analyzing TeamCity build IDs: $BUILD_IDS"

          ALL_ERRORS=""

          if [ -z "$BUILD_IDS" ]; then
            echo "No TeamCity build IDs found"
            echo "errors=No TeamCity build IDs found for this PR" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Fetch build logs from TeamCity
          for BUILD_ID in $BUILD_IDS; do
            echo "Fetching build log for build $BUILD_ID..."

            BUILD_LOG=$(curl -sS \
              -H "Authorization: Bearer $TEAMCITY_TOKEN" \
              -H "Accept: text/plain" \
              "$TEAMCITY_URL/app/rest/builds/id:$BUILD_ID/log" 2>&1 | tail -n 500 || echo "")

            if [ -n "$BUILD_LOG" ]; then
              echo "Analyzing build log for errors..."

              # Extract compilation errors
              COMPILE_ERRORS=$(echo "$BUILD_LOG" | grep -iE "error[: ]|fatal[: ]" | head -n 50 || echo "")

              # Extract linker errors
              LINKER_ERRORS=$(echo "$BUILD_LOG" | grep -E "undefined reference|unresolved external|cannot find -l" | head -n 20 || echo "")

              # Extract CMake errors
              CMAKE_ERRORS=$(echo "$BUILD_LOG" | grep -E "CMake Error" | head -n 20 || echo "")

              # Combine errors
              if [ -n "$COMPILE_ERRORS" ]; then
                ALL_ERRORS="${ALL_ERRORS}"$'\n\n'"=== Build $BUILD_ID - Compilation Errors ==="$'\n'"${COMPILE_ERRORS}"
              fi
              if [ -n "$LINKER_ERRORS" ]; then
                ALL_ERRORS="${ALL_ERRORS}"$'\n\n'"=== Build $BUILD_ID - Linker Errors ==="$'\n'"${LINKER_ERRORS}"
              fi
              if [ -n "$CMAKE_ERRORS" ]; then
                ALL_ERRORS="${ALL_ERRORS}"$'\n\n'"=== Build $BUILD_ID - CMake Errors ==="$'\n'"${CMAKE_ERRORS}"
              fi

              # If no specific errors found, include last 100 lines
              if [ -z "$COMPILE_ERRORS" ] && [ -z "$LINKER_ERRORS" ] && [ -z "$CMAKE_ERRORS" ]; then
                FALLBACK=$(echo "$BUILD_LOG" | tail -n 100)
                ALL_ERRORS="${ALL_ERRORS}"$'\n\n'"=== Build $BUILD_ID - Last 100 lines ==="$'\n'"${FALLBACK}"
              fi
            fi
          done

          # Save errors to output
          echo "ERRORS<<EOF" >> "$GITHUB_OUTPUT"
          echo "$ALL_ERRORS" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Post Comment with Errors
        if: steps.get_pr.outputs.result != 'null'
        uses: actions/github-script@v8
        with:
          script: |
            const prNumber = ${{ steps.get_pr.outputs.result }};
            const errors = `${{ steps.analyze.outputs.ERRORS }}`;
            const buildIdsStr = '${{ steps.extract_build_ids.outputs.build_ids }}';
            const buildIds = buildIdsStr.trim().split(/\s+/).filter(id => id.length > 0);
            const workflowRunId = ${{ github.event.workflow_run.id }};

            let body = '## üîç Build Error Analysis\n\n';
            body += '### @github-copilot\n\n';

            if (!errors || errors.trim() === 'No TeamCity build IDs found for this PR') {
              body += '**Status:** TeamCity CI failed, but build error details could not be extracted.\n\n';
              body += 'Possible reasons:\n';
              body += '- Build artifacts were not uploaded\n';
              body += '- Build IDs could not be extracted from artifacts\n';
              body += '- TeamCity builds may still be in progress\n\n';
              body += `Please check the [TeamCity CI workflow run](${github.event.workflow_run.html_url}) for details.\n`;
            } else {
              body += '**TeamCity CI Build Failed** ‚ùå\n\n';
              body += 'Please analyze the following build errors and suggest specific fixes:\n\n';
              body += '```\n' + errors.trim() + '\n```\n\n';

              // Add TeamCity build links
              if (buildIds.length > 0) {
                body += '### TeamCity Build Links\n\n';
                for (const buildId of buildIds) {
                  body += `- [Build ${buildId}](${{ vars.TEAMCITY_URL }}/viewLog.html?buildId=${buildId})\n`;
                }
                body += '\n';
              }
            }

            body += '---\n\n';
            body += `*Posted automatically by [Build Error Analysis](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) when TeamCity CI failed*\n\n`;
            body += `üìù To manually run analysis again, use the [Analyze Build Errors workflow](${{ github.server_url }}/${{ github.repository }}/actions/workflows/analyze-build-errors.yml) with PR number ${prNumber}.`;

            // Post comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body
            });

            console.log(`Posted build error analysis comment to PR #${prNumber}`);
