name: Auto-Fix on Build Failure

on:
  workflow_run:
    workflows: ["TeamCity CI"]
    types:
      - completed

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  auto-fix:
    name: Attempt Auto-Fix
    runs-on: ubuntu-latest
    # Only run on failed builds from pull requests in the same repository (not forks)
    # This allows the workflow to run automatically without requiring approval
    if: |
      github.event.workflow_run.conclusion == 'failure' &&
      github.event.workflow_run.event == 'pull_request' &&
      github.event.workflow_run.head_repository.full_name == github.repository
    steps:
      - name: Get PR Information
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const pulls = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: `${context.repo.owner}:${context.payload.workflow_run.head_branch}`
            });
            if (pulls.data.length === 0) {
              console.log('No open PR found for this branch');
              return null;
            }
            const pr = pulls.data[0];
            console.log(`Found PR #${pr.number}: ${pr.title}`);
            return {
              number: pr.number,
              head_sha: pr.head.sha,
              head_ref: pr.head.ref
            };

      - name: Checkout PR branch
        if: steps.pr.outputs.result != 'null'
        uses: actions/checkout@v6
        with:
          ref: ${{ fromJSON(steps.pr.outputs.result).head_ref }}
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Analyze Build Failure
        if: steps.pr.outputs.result != 'null'
        id: analyze
        env:
          TEAMCITY_URL: ${{ vars.TEAMCITY_URL }}
          TEAMCITY_TOKEN: ${{ vars.TEAMCITY_TOKEN }}
        shell: bash
        run: |
          echo "Analyzing build failure patterns..."
          
          # Initialize variables
          issue_type="unknown"
          fix_available="false"
          build_problems=""
          
          # Check if TeamCity configuration is available
          if [ -z "${TEAMCITY_URL:-}" ] || [ -z "${TEAMCITY_TOKEN:-}" ]; then
            echo "⚠️ TeamCity configuration not available - cannot fetch detailed build errors"
            echo "Will skip detailed analysis"
          else
            echo "Fetching build problems from TeamCity..."
            
            # Get the workflow run that triggered this auto-fix
            WORKFLOW_RUN_ID="${{ github.event.workflow_run.id }}"
            
            # Get jobs from the triggering workflow run
            JOBS_RESPONSE=$(curl -sS \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/${{ github.repository }}/actions/runs/$WORKFLOW_RUN_ID/jobs")
            
            # Extract TeamCity build IDs from job logs or outputs
            # Look for build IDs in the "Fetch Build Logs" step outputs
            echo "Checking for TeamCity build problems in workflow run logs..."
            
            # Extract build problem information from the jobs
            BUILD_PROBLEMS=$(echo "$JOBS_RESPONSE" | jq -r '.jobs[]? | select(.conclusion == "failure") | .name' || echo "")
            
            if [ -n "$BUILD_PROBLEMS" ]; then
              echo "Found failed jobs: $BUILD_PROBLEMS"
              build_problems="$BUILD_PROBLEMS"
              
              # Check for common patterns in job names or available information
              if echo "$BUILD_PROBLEMS" | grep -qi "linux\|windows"; then
                echo "Detected platform-specific build failure"
                issue_type="build_failure"
              fi
            else
              echo "No specific build problems extracted from workflow"
            fi
          fi
          
          echo "issue_type=$issue_type" >> "$GITHUB_OUTPUT"
          echo "fix_available=$fix_available" >> "$GITHUB_OUTPUT"
          echo "BUILD_PROBLEMS<<EOF" >> "$GITHUB_OUTPUT"
          echo "$build_problems" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"
          echo "Build failure analysis complete"

      - name: Attempt Common Fixes
        if: steps.pr.outputs.result != 'null'
        id: fix
        shell: bash
        run: |
          echo "Checking for common fixable issues..."
          CHANGES_MADE=false
          
          # Get build problems from analyze step
          BUILD_PROBLEMS="${{ steps.analyze.outputs.BUILD_PROBLEMS }}"
          ISSUE_TYPE="${{ steps.analyze.outputs.issue_type }}"
          
          if [ -n "$BUILD_PROBLEMS" ] && [ "$BUILD_PROBLEMS" != "" ]; then
            echo "Build problems detected:"
            echo "$BUILD_PROBLEMS"
            echo ""
            echo "Issue type: $ISSUE_TYPE"
            
            # In future: Add actual fix logic here based on issue_type
            # For now, we just recognize that errors exist
            echo "Auto-fix logic not yet implemented for detected issues"
            echo "This workflow now successfully recognizes build errors"
          else
            echo "No specific build problems to fix"
          fi
          
          echo "changes_made=$CHANGES_MADE" >> "$GITHUB_OUTPUT"

      - name: Commit and Push Fixes
        if: steps.fix.outputs.changes_made == 'true'
        shell: bash
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "Auto-fix: Resolve build errors"
          git push

      - name: Comment on PR
        if: steps.pr.outputs.result != 'null'
        uses: actions/github-script@v7
        with:
          script: |
            const prInfo = JSON.parse('${{ steps.pr.outputs.result }}');
            const changesMade = '${{ steps.fix.outputs.changes_made }}' === 'true';
            const buildProblems = `${{ steps.analyze.outputs.BUILD_PROBLEMS }}`;
            const issueType = '${{ steps.analyze.outputs.issue_type }}';

            let body;
            if (changesMade) {
              body = '✅ Auto-fix applied. Please review the changes.';
            } else {
              body = '⚠️ Build failed. Auto-fix workflow has analyzed the failure.\n\n';
              
              if (buildProblems && buildProblems.trim()) {
                body += '**Detected Issues:**\n';
                body += '```\n' + buildProblems + '\n```\n\n';
                body += `**Issue Type:** ${issueType}\n\n`;
              }
              
              body += '**Status:** Build errors were recognized by the auto-fix workflow.\n';
              body += '**Action Required:** Manual fix needed. Auto-fix logic for these errors is not yet implemented.\n\n';
              body += 'Check the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) and [build logs](${{ github.event.workflow_run.html_url }}) for details.';
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prInfo.number,
              body: body
            });
